---
title: "Homework2_NZ"
author: "Nicolas Zapata"
date: "2025-11-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="/users/j/n/jnzapata/projects/eco_genomics_2025/Transcriptomics/mydata")

```

```{r}
run_topgo_analysis <- function(res_object, generation_label, go_file_path) {
  library(topGO)
  library(GO.db)
  library(dplyr)
  library(ggplot2)

  # Convert DESeq2 results to data frame
  res_df <- as.data.frame(res_object)
  res_df$geneID <- rownames(res_df)
  res_df <- res_df[, c("geneID", setdiff(names(res_df), "geneID"))]

  # Read GO annotations
  tonsa_go <- read.delim(go_file_path, header = TRUE) %>%
    slice(-c(1,2)) %>%
    na.omit()

  # Filter DEGs with GO terms
  res_GO <- res_df[res_df$geneID %in% tonsa_go$geneID, ]
  res_GO_sig <- subset(res_GO, padj < 0.05 & abs(log2FoldChange) > 1)
  tonsa_stat <- merge(res_GO_sig, tonsa_go, by = "geneID")

  # Create gene2GO list
  gene2GO <- tonsa_go %>%
    filter(!is.na(GO) & GO != "") %>%
    group_by(geneID) %>%
    summarise(GO = list(unique(GO)), .groups = "drop") %>%
    with(setNames(GO, geneID))
  gene2GO <- lapply(gene2GO, function(x) unlist(strsplit(x, ";")))

  # Create geneList
  all_genes <- names(gene2GO)
  geneList <- setNames(as.integer(all_genes %in% tonsa_stat$geneID), all_genes)

  # Build TopGO object
  GOdata <- new("topGOdata",
                description = paste("GO enrichment for", generation_label),
                ontology = "BP",
                allGenes = geneList,
                geneSel = function(x) x == 1,
                nodeSize = 5,
                annot = annFUN.gene2GO,
                gene2GO = gene2GO)

  # Run enrichment test
  result <- runTest(GOdata, algorithm = "parentChild", statistic = "fisher")
  res_table <- GenTable(GOdata, classicFisher = result,
                        topNodes = length(usedGO(GOdata))) %>%
    mutate(classicFisher = as.numeric(classicFisher),
           Annotated = as.numeric(Annotated),
           Significant = as.numeric(Significant))

  # Filter results
  filtered_GO_results <- res_table %>%
    filter(Annotated >= 5 & Annotated < 500) %>%
    group_by(Term) %>%
    slice_min(classicFisher, n = 1) %>%
    ungroup() %>%
    arrange(classicFisher)

  # Create plot only if there are results
  if (nrow(filtered_GO_results) > 0) {
    p <- ggplot(filtered_GO_results %>% slice_head(n = 15),
                aes(x = -log10(classicFisher),
                    y = reorder(Term, -log10(classicFisher)),
                    size = Significant,
                    color = -log10(classicFisher))) +
      geom_point(alpha = 0.8) +
      scale_color_gradientn(colors = c("pink", "orchid", "purple", "purple4"),
                            name = "-log10(p-value)") +
      scale_size_continuous(name = "# Significant Genes") +
      xlab("-log10-classicFisher") +
      ylab("Biological Function") +
      ggtitle(paste("GO Enrichment for DEGs at", generation_label)) +
      theme_minimal() +
      theme(plot.margin = margin(10, 100, 10, 10),
            axis.text.y = element_text(size = 5, hjust = 1)) +
      coord_cartesian(clip = "off")
    print(p)
  } else {
    message("⚠️ No hay términos GO significativos para graficar en ", generation_label)
    p <- NULL
  }

  return(list(plot = p, table = filtered_GO_results))  
}

```

```{r}

gen1_results <- run_topgo_analysis(resG1_CvT, "Gen1", "Genes_GO_terms_output.tsv")
gen2_results <- run_topgo_analysis(resG2_CvT, "Gen2", "Genes_GO_terms_output.tsv")
gen3_results <- run_topgo_analysis(resG3_CvT, "Gen3", "Genes_GO_terms_output.tsv")
gen4_results <- run_topgo_analysis(resG4_CvT, "Gen4", "Genes_GO_terms_output.tsv")

# Ver gráficos
gen1_results$plot
gen2_results$plot

# Acceder a tablas
gen1_results$table
gen2_results$table


```

```{r}
# 1. Definir la función
export_revigo_files <- function(results_list, generation_labels) {
  for (i in seq_along(results_list)) {
    res_table <- results_list[[i]]$table
    label <- generation_labels[i]

    revigo_input <- res_table[, c("GO.ID", "classicFisher")]
    sigRes <- revigo_input[as.numeric(revigo_input$classicFisher) < 0.05, ]
    colnames(sigRes) <- c("GO.ID", "pValue")

    write.table(sigRes,
                file = paste0("topGOsig_", label, "_for_REVIGO.txt"),
                sep = "\t", row.names = FALSE, quote = FALSE)
  }
}

# 2. Ejecutar la función con tus resultados
results_list <- list(gen1_results, gen2_results, gen3_results, gen4_results)
labels <- c("Gen1", "Gen2", "Gen3", "Gen4")

export_revigo_files(results_list, labels)

```

```{r}
library(readr)
library(dplyr)

# REVIGO data 
revigo_G1 <- read_tsv("REVIGO_Gen1.tsv") %>% mutate(Generation = "Gen1")
revigo_G2 <- read_tsv("REVIGO_Gen2.tsv") %>% mutate(Generation = "Gen2")
revigo_G3 <- read_tsv("REVIGO_Gen3.tsv") %>% mutate(Generation = "Gen3")
revigo_G4 <- read_tsv("REVIGO_Gen4.tsv") %>% mutate(Generation = "Gen4")

# join all

revigo_all <- bind_rows(revigo_G1, revigo_G2, revigo_G3, revigo_G4)


```

```{r}
nrow(revigo_all_clean)

```

```{r}
table(revigo_all_clean$Generation)
```

```{r}

revigo_all_clean <- revigo_all %>%
  mutate(Value = ifelse(Value <= 0 | is.na(Value), 1e-10, Value))

ggplot(revigo_all_clean, aes(x = PC_0, y = PC_1,
                             size = Frequency,
                             color = -log10(Value))) +
  geom_point(alpha = 0.7) +
  facet_wrap(~ Generation) +
  scale_color_gradientn(colors = c("yellow", "orange", "red", "purple")) +
  theme_minimal() +
  labs(title = "Semantic comparison between generations",
       x = "MDS axis PC_0 (semantic similarity)",
       y = "MDS axis PC_1 (semantic similarity)",
       size = "GO term frequency",
       color = "-log10(p-value)")





```



```{r}
ggplot(revigo_all_clean, aes(x = PC_0, y = PC_1,
                             size = Frequency,
                             color = Generation)) +
  geom_point(alpha = 0.7) +
  theme_minimal() +
  labs(title = "Semantic space of GO terms across generations",
       x = "Semantic axis PC_0",
       y = "Semantic axis PC_1",
       size = "GO term frequency",
       color = "Generation")
```





```{r}
library(ggrepel)

highlight_terms <- revigo_all_clean %>%
  filter(Value < 0.01)

ggplot(revigo_all_clean, aes(x = PC_0, y = PC_1)) +
  geom_point(aes(size = Frequency, color = Generation), alpha = 0.5) +
  geom_point(data = highlight_terms, aes(size = Frequency), color = "black", shape = 21, stroke = 1.2) +
  geom_text_repel(data = highlight_terms, aes(label = Name), size = 3) +
  theme_minimal() +
  labs(title = "Highlighted significant GO terms in semantic space",
       x = "Semantic axis PC_0",
       y = "Semantic axis PC_1")

```



```{r}
library(ggplot2)
library(ggrepel)
library(dplyr)

# Filtrar los términos más significativos
highlight_terms <- revigo_all_clean %>%
  filter(Value < 0.01)

# Scatter plot con etiquetas
ggplot(revigo_all_clean, aes(x = PC_0, y = PC_1)) +
  geom_point(aes(size = Frequency, color = Generation), alpha = 0.6) +
  geom_point(data = highlight_terms, aes(size = Frequency), color = "black", shape = 21, stroke = 1.2) +
  geom_text_repel(data = highlight_terms, aes(label = Name), size = 3, max.overlaps = 20) +
  scale_color_manual(values = c("Gen1" = "red", "Gen2" = "green", "Gen3" = "blue", "Gen4" = "purple")) +
  theme_minimal(base_size = 12) +
  labs(title = "Semantic space of significant GO terms across generations",
       x = "Semantic axis PC_0",
       y = "Semantic axis PC_1",
       size = "GO term frequency",
       color = "Generation")


```



```{r}
library(dplyr)
library(tidyr)
library(ggplot2)

# Filtrar top 10 términos por generación
top_terms <- revigo_all_clean %>%
  group_by(Generation) %>%
  slice_min(order_by = Value, n = 10) %>%
  ungroup()

# Crear matriz: GO term vs Generation
heatmap_data <- top_terms %>%
  select(Generation, Name, Value) %>%
  mutate(Significance = -log10(Value)) %>%
  pivot_wider(names_from = Generation, values_from = Significance)

# Convertir a formato largo para ggplot
heatmap_long <- heatmap_data %>%
  pivot_longer(cols = -Name, names_to = "Generation", values_to = "Significance")

# Graficar heatmap
ggplot(heatmap_long, aes(x = Generation, y = Name, fill = Significance)) +
  geom_tile(color = "white") +
  scale_fill_gradientn(colors = c("white", "yellow", "orange", "red", "purple"),
                       na.value = "grey90") +
  theme_minimal(base_size = 11) +
  labs(title = "GO term significance across generations",
       x = "Generation",
       y = "GO Term",
       fill = "-log10(p-value)")

```

